# scripts/test_stock_collector.py
"""
Script para testar o Agente Coletor de forma simples
"""
import asyncio
import sys
import json
import logging
from datetime import datetime

# Configurar logging
logging.basicConfig(level=logging.INFO, format='%(levelname)s: %(message)s')
logger = logging.getLogger(__name__)

# Adicionar path do projeto
sys.path.insert(0, '.')


async def test_yfinance_direct():
    """Testa YFinance diretamente"""
    try:
        logger.info("üß™ Testando YFinance diretamente...")
        
        # Instalar yfinance se necess√°rio
        try:
            import yfinance as yf
        except ImportError:
            logger.info("üì¶ Instalando yfinance...")
            import subprocess
            subprocess.check_call([sys.executable, "-m", "pip", "install", "yfinance"])
            import yfinance as yf
        
        # Testar algumas a√ß√µes brasileiras
        test_symbols = ["PETR4.SA", "VALE3.SA", "ITUB4.SA"]
        results = []
        
        for symbol in test_symbols:
            try:
                logger.info(f"   Testando {symbol}...")
                ticker = yf.Ticker(symbol)
                
                # Buscar informa√ß√µes b√°sicas
                info = ticker.info
                hist = ticker.history(period="1d")
                
                if not hist.empty and info:
                    price = hist['Close'].iloc[-1] if not hist.empty else info.get('regularMarketPrice', 0)
                    volume = hist['Volume'].iloc[-1] if not hist.empty else info.get('regularMarketVolume', 0)
                    
                    stock_data = {
                        "symbol": symbol,
                        "name": info.get('shortName') or info.get('longName') or symbol,
                        "price": float(price) if price else 0,
                        "volume": int(volume) if volume else 0,
                        "market_cap": info.get('marketCap'),
                        "pe_ratio": info.get('trailingPE'),
                        "success": True
                    }
                    
                    results.append(stock_data)
                    logger.info(f"   ‚úÖ {symbol}: {stock_data['name']} - R$ {stock_data['price']:.2f}")
                else:
                    results.append({"symbol": symbol, "success": False, "error": "Sem dados"})
                    logger.warning(f"   ‚ö†Ô∏è {symbol}: Sem dados dispon√≠veis")
                    
            except Exception as e:
                results.append({"symbol": symbol, "success": False, "error": str(e)})
                logger.error(f"   ‚ùå {symbol}: {e}")
        
        successful = sum(1 for r in results if r.get("success"))
        logger.info(f"üìä YFinance: {successful}/{len(test_symbols)} sucessos")
        
        return results
        
    except Exception as e:
        logger.error(f"‚ùå Erro no teste YFinance: {e}")
        return []


async def test_database_integration():
    """Testa integra√ß√£o com banco de dados"""
    try:
        logger.info("üß™ Testando integra√ß√£o com banco...")
        
        from database.repositories import get_stock_repository
        stock_repo = get_stock_repository()
        
        # Verificar a√ß√µes existentes
        existing_stocks = stock_repo.get_all_stocks()
        logger.info(f"   üìã {len(existing_stocks)} a√ß√µes no banco")
        
        # Testar cria√ß√£o/atualiza√ß√£o
        test_stock_data = {
            "codigo": "TEST4",
            "nome": "A√ß√£o de Teste",
            "preco_atual": 25.50,
            "volume_medio": 1000000,
            "setor": "Teste",
            "ativo": True
        }
        
        # Verificar se j√° existe
        existing = stock_repo.get_stock_by_code("TEST4")
        if existing:
            # Atualizar pre√ßo
            success = stock_repo.update_stock_price("TEST4", 26.00, 1100000)
            if success:
                logger.info("   ‚úÖ Atualiza√ß√£o de pre√ßo OK")
            else:
                logger.warning("   ‚ö†Ô∏è Falha na atualiza√ß√£o")
        else:
            # Criar nova
            new_stock = stock_repo.create_stock(test_stock_data)
            if new_stock:
                logger.info(f"   ‚úÖ Cria√ß√£o OK - ID: {new_stock.id}")
            else:
                logger.warning("   ‚ö†Ô∏è Falha na cria√ß√£o")
        
        return True
        
    except Exception as e:
        logger.error(f"‚ùå Erro na integra√ß√£o DB: {e}")
        return False


async def test_simplified_collector():
    """Testa vers√£o simplificada do coletor"""
    try:
        logger.info("üß™ Testando coletor simplificado...")
        
        from database.repositories import get_stock_repository
        import yfinance as yf
        
        stock_repo = get_stock_repository()
        
        # A√ß√µes para testar
        test_codes = ["PETR4", "VALE3", "ITUB4"]
        results = {
            "total": len(test_codes),
            "successful": 0,
            "failed": 0,
            "details": []
        }
        
        for codigo in test_codes:
            try:
                logger.info(f"   Processando {codigo}...")
                
                # Buscar dados no YFinance
                symbol = f"{codigo}.SA"
                ticker = yf.Ticker(symbol)
                info = ticker.info
                hist = ticker.history(period="1d")
                
                if info and not hist.empty:
                    price = hist['Close'].iloc[-1]
                    volume = hist['Volume'].iloc[-1]
                    
                    # Verificar se a√ß√£o existe no banco
                    existing = stock_repo.get_stock_by_code(codigo)
                    
                    if existing:
                        # Atualizar pre√ßo
                        success = stock_repo.update_stock_price(codigo, float(price), int(volume))
                        action = "updated"
                    else:
                        # Criar nova a√ß√£o
                        stock_data = {
                            "codigo": codigo,
                            "nome": info.get('shortName') or info.get('longName') or codigo,
                            "preco_atual": float(price),
                            "volume_medio": int(volume),
                            "market_cap": info.get('marketCap'),
                            "p_l": info.get('trailingPE'),
                            "p_vp": info.get('priceToBook'),
                            "setor": "Coletado",
                            "ativo": True
                        }
                        new_stock = stock_repo.create_stock(stock_data)
                        success = new_stock is not None
                        action = "created"
                    
                    if success:
                        results["successful"] += 1
                        results["details"].append({
                            "codigo": codigo,
                            "action": action,
                            "price": float(price),
                            "volume": int(volume),
                            "success": True
                        })
                        logger.info(f"   ‚úÖ {codigo}: {action} - R$ {price:.2f}")
                    else:
                        results["failed"] += 1
                        results["details"].append({
                            "codigo": codigo,
                            "success": False,
                            "error": "Falha no banco de dados"
                        })
                        logger.error(f"   ‚ùå {codigo}: Falha no banco")
                else:
                    results["failed"] += 1
                    results["details"].append({
                        "codigo": codigo,
                        "success": False,
                        "error": "Sem dados do YFinance"
                    })
                    logger.warning(f"   ‚ö†Ô∏è {codigo}: Sem dados")
                    
            except Exception as e:
                results["failed"] += 1
                results["details"].append({
                    "codigo": codigo,
                    "success": False,
                    "error": str(e)
                })
                logger.error(f"   ‚ùå {codigo}: {e}")
        
        logger.info(f"üìä Coletor: {results['successful']}/{results['total']} sucessos")
        return results
        
    except Exception as e:
        logger.error(f"‚ùå Erro no coletor: {e}")
        return {}


async def test_agno_agent():
    """Testa o agente Agno completo"""
    try:
        logger.info("üß™ Testando Agente Agno...")
        
        # Verificar se agno est√° instalado
        try:
            from agno import Agent
        except ImportError:
            logger.warning("‚ö†Ô∏è Agno n√£o est√° instalado - testando apenas funcionalidade b√°sica")
            return await test_simplified_collector()
        
        # Tentar importar o agente
        try:
            from agents.collectors.stock_collector import StockCollectorAgent
        except ImportError as e:
            logger.error(f"‚ùå Erro ao importar agente: {e}")
            logger.info("üîÑ Usando coletor simplificado...")
            return await test_simplified_collector()
        
        # Criar e testar agente
        collector = StockCollectorAgent()
        test_stocks = ["PETR4", "VALE3", "ITUB4"]
        
        # Iniciar sess√£o
        session_id = await collector.start_collection_session(test_stocks)
        logger.info(f"   üìã Sess√£o: {session_id}")
        
        # Buscar tool de coleta
        collect_tool = None
        for tool in collector.tools:
            if tool.name == "collect_stock_data":
                collect_tool = tool
                break
        
        if collect_tool:
            # Executar coleta
            results = await collect_tool(test_stocks)
            await collector.finish_collection_session(results)
            
            logger.info(f"   üìä Total: {results['total_requested']}")
            logger.info(f"   ‚úÖ Sucessos: {results['successful']}")
            logger.info(f"   ‚ùå Falhas: {results['failed']}")
            logger.info(f"   ‚è±Ô∏è Tempo: {results['processing_time']:.2f}s")
            
            return results
        else:
            logger.error("‚ùå Tool n√£o encontrada")
            return {}
            
    except Exception as e:
        logger.error(f"‚ùå Erro no agente Agno: {e}")
        logger.info("üîÑ Usando coletor simplificado...")
        return await test_simplified_collector()


async def main():
    """Fun√ß√£o principal de teste"""
    logger.info("üöÄ TESTE DO AGENTE COLETOR - PASSO 3")
    logger.info("=" * 50)
    
    # 1. Testar YFinance
    logger.info("\n1Ô∏è‚É£ TESTE YFINANCE")
    logger.info("-" * 30)
    yf_results = await test_yfinance_direct()
    
    # 2. Testar banco de dados
    logger.info("\n2Ô∏è‚É£ TESTE BANCO DE DADOS")
    logger.info("-" * 30)
    db_success = await test_database_integration()
    
    # 3. Testar coletor (simplificado ou Agno)
    logger.info("\n3Ô∏è‚É£ TESTE COLETOR")
    logger.info("-" * 30)
    collector_results = await test_agno_agent()
    
    # Resumo final
    logger.info("\nüìä RESUMO FINAL")
    logger.info("=" * 50)
    
    yf_success = sum(1 for r in yf_results if r.get("success"))
    logger.info(f"YFinance: {yf_success}/{len(yf_results)} sucessos")
    logger.info(f"Banco de dados: {'‚úÖ OK' if db_success else '‚ùå Falha'}")
    
    if collector_results:
        if isinstance(collector_results, dict) and "successful" in collector_results:
            logger.info(f"Coletor: {collector_results['successful']}/{collector_results.get('total', 0)} sucessos")
        else:
            logger.info("Coletor: Executado (formato diferente)")
    else:
        logger.info("Coletor: ‚ùå Falha")
    
    # Status do Passo 3
    logger.info("\nüéØ STATUS DO PASSO 3")
    logger.info("-" * 30)
    
    if yf_success >= 2 and db_success and collector_results:
        logger.info("‚úÖ PASSO 3 CONCLU√çDO COM SUCESSO!")
        logger.info("üöÄ Pronto para Passo 4: Automa√ß√£o e Agendamento")
    elif yf_success >= 2 and db_success:
        logger.info("üî∂ PASSO 3 PARCIALMENTE CONCLU√çDO")
        logger.info("üí° YFinance e banco funcionam - pode prosseguir")
        logger.info("üîß Considere melhorar o agente Agno se necess√°rio")
    else:
        logger.warning("‚ö†Ô∏è PASSO 3 COM PROBLEMAS")
        logger.info("üîß Corrija os problemas antes de prosseguir:")
        if yf_success < 2:
            logger.info("   - Verificar conex√£o YFinance")
        if not db_success:
            logger.info("   - Verificar banco de dados")
        if not collector_results:
            logger.info("   - Verificar implementa√ß√£o do coletor")
    
    return {
        "yfinance": yf_results,
        "database": db_success,
        "collector": collector_results
    }


if __name__ == "__main__":
    asyncio.run(main())
